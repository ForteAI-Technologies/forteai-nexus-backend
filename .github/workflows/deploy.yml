name: Backend Deployment Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2️⃣ Install sshpass
      - name: Install sshpass
        run: |
          sudo apt-get update -y
          sudo apt-get install -y sshpass

      # 3️⃣ Ensure Bastion deploy directory exists (error fix added)
      - name: Prepare Bastion Directory
        run: |
          echo "Preparing Bastion directory..."
          sshpass -p 'forteai@123' ssh -o StrictHostKeyChecking=no ec2-user@52.66.158.199 "
            if [ ! -d /tmp/backend-deploy ]; then
              echo 'Directory missing, creating /tmp/backend-deploy...'
              mkdir -p /tmp/backend-deploy
            fi
            echo 'Cleaning up old files...'
            rm -rf /tmp/backend-deploy/*
          "

      # 4️⃣ Copy backend repo files to Bastion
      - name: Copy Backend Files to Bastion
        run: |
          echo "Copying files to Bastion..."
          sshpass -p 'forteai@123' scp -o StrictHostKeyChecking=no -r ./ ec2-user@52.66.158.199:/tmp/backend-deploy/ || {
            echo "❌ SCP to Bastion failed — checking directory and retrying..."
            sshpass -p 'forteai@123' ssh -o StrictHostKeyChecking=no ec2-user@52.66.158.199 "mkdir -p /tmp/backend-deploy"
            sshpass -p 'forteai@123' scp -o StrictHostKeyChecking=no -r ./ ec2-user@52.66.158.199:/tmp/backend-deploy/
          }

      # 5️⃣ Copy files from Bastion to Backend EC2
      - name: Copy Files from Bastion to Backend EC2
        run: |
          sshpass -p 'forteai@123' ssh -o StrictHostKeyChecking=no ec2-user@52.66.158.199 "
            sshpass -p 'forteai@12345' ssh -o StrictHostKeyChecking=no ec2-user@10.0.157.0 '
              mkdir -p /home/ec2-user/forteai-nexus-backend &&
              rm -rf /home/ec2-user/forteai-nexus-backend/*
            '
            sshpass -p 'forteai@12345' scp -o StrictHostKeyChecking=no -r /tmp/backend-deploy/* ec2-user@10.0.157.0:/home/ec2-user/forteai-nexus-backend/
          "

      # 6️⃣ Create .env file on backend EC2
      - name: Setup Environment File
        run: |
          echo "Setting up .env file on backend..."
          sshpass -p 'forteai@123' ssh -o StrictHostKeyChecking=no ec2-user@52.66.158.199 "
            sshpass -p 'forteai@12345' scp -o StrictHostKeyChecking=no /tmp/backend-deploy/.env ec2-user@10.0.157.0:/home/ec2-user/forteai-nexus-backend/.env
          "

      # 7️⃣ Install dependencies & restart backend using PM2
      - name: Install Dependencies and Restart Backend
        run: |
          echo "Installing dependencies and restarting app..."
          sshpass -p 'forteai@123' ssh -o StrictHostKeyChecking=no ec2-user@52.66.158.199 "
            sshpass -p 'forteai@12345' ssh -o StrictHostKeyChecking=no ec2-user@10.0.157.0 '
              cd /home/ec2-user/forteai-nexus-backend

              # Ensure Node.js & PM2 exist
              if ! command -v node >/dev/null 2>&1; then
                echo Installing Node.js...
                curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
                sudo yum install -y nodejs
              fi

              if ! command -v pm2 >/dev/null 2>&1; then
                echo Installing PM2...
                sudo npm install -g pm2
              fi

              # Install dependencies
              npm install

              # Restart or start backend service
              if pm2 list | grep -q forteai-backend; then
                echo Restarting existing process...
                pm2 restart forteai-backend
              else
                echo Starting new process...
                pm2 start server.js --name forteai-backend
              fi

              pm2 save
            '
          "

 
